<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v9.1.4 <https://hydejack.com/>
--><head><title>Java, XML og sikkerhet, juni 2021 | Fjanks security pages</title><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Java, XML og sikkerhet, juni 2021" /><meta name="author" content="Frank Karlstr√∏m" /><meta property="og:locale" content="en" /><meta name="description" content="TL;DR JAXP er Oracle Javas XML API som kan brukes for lesing, skriving og prosessering av XML. Alle metodene i JAXP er ‚Äúvulnerable by design‚Äù ü§Ø og s√•rbare for blant annet XXE. Som Javautvikler m√• du som regel forholde deg til XML, man b√∏r bruke defence-in-depth tankegang, og skru p√• alle sikkerhets-features for XML. XXE er s√•rbarheten det fokuseres p√• i denne artikkelen, men det finnes flere. Ikke tro! Ha h√•ndfaste bevis for deg selv basert p√• det du selv vet. Dessverre er det ingen shortcuts, fyr opp en kanne kaffe og les JAXP Security Guide. Eller enda bedre, les denne artikkelen, forh√•pentligvis ikke s√• knuskt√∏rr!" /><meta property="og:description" content="TL;DR JAXP er Oracle Javas XML API som kan brukes for lesing, skriving og prosessering av XML. Alle metodene i JAXP er ‚Äúvulnerable by design‚Äù ü§Ø og s√•rbare for blant annet XXE. Som Javautvikler m√• du som regel forholde deg til XML, man b√∏r bruke defence-in-depth tankegang, og skru p√• alle sikkerhets-features for XML. XXE er s√•rbarheten det fokuseres p√• i denne artikkelen, men det finnes flere. Ikke tro! Ha h√•ndfaste bevis for deg selv basert p√• det du selv vet. Dessverre er det ingen shortcuts, fyr opp en kanne kaffe og les JAXP Security Guide. Eller enda bedre, les denne artikkelen, forh√•pentligvis ikke s√• knuskt√∏rr!" /><link rel="canonical" href="https://fjank.no/blog/2021-06-28-java-xml-security/" /><meta property="og:url" content="https://fjank.no/blog/2021-06-28-java-xml-security/" /><meta property="og:site_name" content="Fjanks security pages" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-28T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Java, XML og sikkerhet, juni 2021" /> <script type="application/ld+json"> {"@type":"BlogPosting","headline":"Java, XML og sikkerhet, juni 2021","dateModified":"2021-06-28T21:49:38+02:00","datePublished":"2021-06-28T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://fjank.no/blog/2021-06-28-java-xml-security/"},"author":{"@type":"Person","name":"Frank Karlstr√∏m"},"url":"https://fjank.no/blog/2021-06-28-java-xml-security/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://fjank.no/assets/img/logo.png"},"name":"Frank Karlstr√∏m"},"description":"TL;DR JAXP er Oracle Javas XML API som kan brukes for lesing, skriving og prosessering av XML. Alle metodene i JAXP er ‚Äúvulnerable by design‚Äù ü§Ø og s√•rbare for blant annet XXE. Som Javautvikler m√• du som regel forholde deg til XML, man b√∏r bruke defence-in-depth tankegang, og skru p√• alle sikkerhets-features for XML. XXE er s√•rbarheten det fokuseres p√• i denne artikkelen, men det finnes flere. Ikke tro! Ha h√•ndfaste bevis for deg selv basert p√• det du selv vet. Dessverre er det ingen shortcuts, fyr opp en kanne kaffe og les JAXP Security Guide. Eller enda bedre, les denne artikkelen, forh√•pentligvis ikke s√• knuskt√∏rr!","@context":"https://schema.org"}</script><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Fjanks security pages"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content="Fjanks security pages"><meta name="theme-color" content="rgb(8,46,57)"><meta name="generator" content="Hydejack v9.1.4" /><link rel="alternate" href="https://fjank.no/blog/2021-06-28-java-xml-security/" hreflang="en"><link type="application/atom+xml" rel="alternate" href="https://fjank.no/feed.xml" title="Fjanks security pages" /><link rel="shortcut icon" href="/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="https://fjank-no.disqus.com" id="_hrefDisqus"> <script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script");n.src=e,t&&a(n,"load",t,{once:!0});t=c.scripts[0];return t.parentNode.insertBefore(n,t),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/'; w._publicPath = '/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = false; w._search = { DATA_URL: '/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/', INDEX_KEY: 'index--2021-06-28T21:53:28+02:00', }; w._clapButton = false; }(window);</script> <script async src="/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,.content .avatar,.nav-btn,.nav-btn-bar,.navbar,.message,.note-sm,#markdown-toc,.note,.hr-bottom,.hr-after::after,hr,.hr,p,body{transition:none}html{--font-family: Noto Sans,Helvetica,Arial,sans-serif;--font-family-heading: Roboto Slab,Helvetica,Arial,sans-serif;--code-font-family: Fira Code,Menlo,Monaco,Consolas,monospace;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: #282828;--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 700;--content-width-5: 54rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-3: 64em;--break-point-5: 86em;--break-point-dynamic: 1664px}html .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}img.lead,video.lead{display:block;max-width:calc(100% + 2rem);width:calc(100% + 2rem);height:auto}.heading,.f6,h6,.h6,.f5,h5,.h5,.f4,.sidebar-nav-item,h4,.h4,.post-date,.f3,h3,.h3,.f2,h2,.h2,.f1,h1,.h1{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,.sidebar-nav-item,h4,.h4,.post-date{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (max-width: 42em){.content h1,.content .h1{font-size:1.7rem;line-height:1.35}}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 1664px){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.2}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:1.5rem}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>header>.lead+.note-sm,body:not(.no-third-column) .page>header>.lead+#markdown-toc,body:not(.no-third-column) .page>header>.lead+.note,body:not(.no-third-column) .page>header>a.no-hover+.note-sm,body:not(.no-third-column) .page>header>a.no-hover+#markdown-toc,body:not(.no-third-column) .page>header>a.no-hover+.note{position:absolute;right:-25rem;width:21rem;bottom:0;margin-bottom:0}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,#breadcrumbs.post-date>ul{cursor:pointer}.post-date [class^="icon-"]{display:inline-block;font-size:smaller;margin-right:.25rem}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,#markdown-toc,.note{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,#markdown-toc,.note{background:transparent;color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,#markdown-toc:before,.note:before{font-size:0.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,#markdown-toc[title]:before,.note[title]:before{content:attr(title) !important}.note{font-size:1rem}@media screen{body::before{content:'';width:.5rem;background:var(--gray-bg);position:fixed;left:0;top:0;bottom:0}}@media (min-width: 64em){body::before{width:21rem}}@media (min-width: 1664px){body::before{width:calc(50% - 31rem)}}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media (min-width: 42em){.border-radius,.lead,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1664px){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,0.75)}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2);text-decoration-color:rgba(255,255,255,0.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,0.2);text-decoration-color:rgba(32,32,32,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:'';display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:rgba(255,255,255,0.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,0.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media (min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-bottom,.fixed-top{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:white;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:2rem -1rem 2rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 1664px){body:not(.no-toc) #markdown-toc{position:absolute;z-index:4;width:20.5rem;right:0;margin:auto;overflow:auto}}@media screen and (min-width: 1664px){body.no-break-layout:not(.no-toc) #markdown-toc{width:calc(50% - 31rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;margin-left:25rem;margin-right:4rem;max-width:54rem}}@media screen and (min-width: 1664px){.content{margin:auto}}.large-only{display:none}@media screen and (min-width: 1664px){.large-only{display:block}}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"}</style><link rel="preload" as="style" href="/assets/css/hydejack-9.1.4.css" id="_stylePreload"><link rel="preload" as="style" href="/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/setRel('_fontsPreload');/**/ </script> <noscript><link rel="stylesheet" href="/assets/css/hydejack-9.1.4.css"><link rel="stylesheet" href="/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap"> </noscript><style id="_pageStyle"> html{--accent-color: rgb(79,177,186);--accent-color-faded: rgba(79,177,186,0.5);--accent-color-highlight: rgba(79,177,186,0.1);--accent-color-darkened: #409ba3;--theme-color: rgb(8,46,57)}</style><!--<![endif]--> <!-- Code used for embedding Gumroad on the Hydejack Site. Left here for reference, feel free to delete. --><link rel="dns-prefetch" href="https://assets.gumroad.com"> <script>window.GET_CLAPS_API = 'https://worker.getclaps.dev'</script> <script type="module"> const ppiData = window._ppiData = fetch('https://hydejack-ppi.qwtel.workers.dev', { mode: 'cors'}).then(res => res.json()).catch(() => ({})); const promisify = f => x => new Promise(r => f(x).addEventListener('load', r)); const loadJS = promisify(window.loadJS); { let p; document.querySelector('hy-push-state').addEventListener('load', () => { const io = new IntersectionObserver(async (entries) => { if (entries.some(x => x.isIntersecting)) { p = p || loadJS('https://gumroad.com/js/gumroad-embed.js'); const [{ code }] = await Promise.all([ppiData, p]); document.querySelectorAll('.gumroad-product-embed').forEach(el => { if (!el.dataset.gumroadParams) { el.dataset.gumroadParams = 'offer_code=' + (code || 'qr0tw8m'); } }); if (!window.GumroadEmbed) { await new Promise(function check1(res) { if ('createGumroadEmbed' in window) res(window.createGumroadEmbed()); else setTimeout(() => check1(res), 200); }); } await new Promise(function check2(res) { if ('GumroadEmbed' in window) res(GumroadEmbed.reload()); else setTimeout(() => check2(res), 200); }); } }, { rootMargin: '1440px' }); document.querySelectorAll('.gumroad-product-embed').forEach(el => io.observe(el)); }); } { let p; document.querySelector('hy-push-state').addEventListener('load', () => { const io = new IntersectionObserver(async (entries) => { if (entries.some(x => x.isIntersecting)) { p = p || loadJS('https://gumroad.com/js/gumroad.js'); const [{ code }] = await Promise.all([ppiData, p]); if (code) { document.querySelectorAll('.gumroad-button').forEach(el => { if (!el.href.endsWith(code)) { el.href = el.href + '/' + (code || 'qr0tw8m'); } }); } if (!window.GumroadOverlay) { await new Promise(function check(res) { if ('createGumroadOverlay' in window) res(window.createGumroadOverlay()); else setTimeout(() => check(res), 200); }); } } }, { rootMargin: '300px' }); document.querySelectorAll('.gumroad-button').forEach(el => io.observe(el)); }); } </script><body class="no-break-layout"> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><div id="_navbar" class="navbar fixed-top"><div class="content"> <span class="sr-only">Jump to:</span><div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a><div class="nav-span"></div></div></div></div><hr class="sr-only" hidden /><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/">home</a><li> <span>/</span> <a href="/blog/">blog</a><li> <span>/</span> <span>2021-06-28-java-xml-security</span></ul></nav><article id="post-blog-java-xml-security" class="page post mb6" role="article"><header><h1 class="post-title flip-project-title"> Java, XML og sikkerhet, juni 2021</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2021-06-28T00:00:00+02:00">28 Jun 2021</time> in <a href="/blog/" class="flip-title">Blog</a> </span></div><p class="note-sm" > TL;DR JAXP er Oracle Javas XML API som kan brukes for lesing, skriving og prosessering av XML. Alle metodene i JAXP er ‚Äúvulnerable by design‚Äù ü§Ø og s√•rbare for blant annet XXE. Som Javautvikler m√• du som regel forholde deg til XML, man b√∏r bruke defence-in-depth tankegang, og skru p√• alle sikkerhets-features for XML. XXE er s√•rbarheten det fokuseres p√• i denne artikkelen, men det finnes flere. Ikke tro! Ha h√•ndfaste bevis for deg selv basert p√• det du selv vet. Dessverre er det ingen shortcuts, fyr opp en kanne kaffe og les <a href="https://docs.oracle.com/en/java/javase/11/security/java-api-xml-processing-jaxp-security-guide.html">JAXP Security Guide</a>. <strong>Eller enda bedre, les denne artikkelen, forh√•pentligvis ikke s√• knuskt√∏rr!</strong></header><ul id="markdown-toc"><li><a href="#hvem-har-nytte-av-lese-dette-" id="markdown-toc-hvem-har-nytte-av-lese-dette-">Hvem har nytte av lese dette? üéØ</a><ul><li><a href="#hvem-bruker-xml-da-kan-vi-ikke-bare-bruke-json-" id="markdown-toc-hvem-bruker-xml-da-kan-vi-ikke-bare-bruke-json-">Hvem bruker XML da, kan vi ikke bare bruke JSON? üòá</a><li><a href="#xml-prosessering-i-java" id="markdown-toc-xml-prosessering-i-java">XML-prosessering i Java</a></ul><li><a href="#er-ikke-java-sikkert-som-banken-da-trenger-man-√•-tenke-p√•-det-" id="markdown-toc-er-ikke-java-sikkert-som-banken-da-trenger-man-√•-tenke-p√•-det-">Er ikke Java sikkert som banken da, trenger man √• tenke p√• det? üôàüôâüôä</a><ul><li><a href="#introduksjon" id="markdown-toc-introduksjon">Introduksjon</a><li><a href="#forutsetninger" id="markdown-toc-forutsetninger">Forutsetninger</a><li><a href="#kode" id="markdown-toc-kode">Kode</a></ul><li><a href="#nasty-stuff-hva-er-dette-" id="markdown-toc-nasty-stuff-hva-er-dette-">Nasty stuff, hva er dette? ü•∂</a><ul><li><a href="#xxe-for-lfi-" id="markdown-toc-xxe-for-lfi-">XXE for LFI üëÄ</a><ul><li><a href="#oob-xxe" id="markdown-toc-oob-xxe">OOB-XXE</a><li><a href="#error-based-xxe" id="markdown-toc-error-based-xxe">Error based XXE</a></ul><li><a href="#xxe-for-dos-" id="markdown-toc-xxe-for-dos-">XXE for DoS üí£</a><li><a href="#xxe-for-portscanning-og-nettverksscanning-" id="markdown-toc-xxe-for-portscanning-og-nettverksscanning-">XXE for portscanning og nettverksscanning üîé</a><li><a href="#xxe-for-ssrf-" id="markdown-toc-xxe-for-ssrf-">XXE for SSRF üê±‚Äçüë§</a><li><a href="#xxe-to-rce-Ô∏è" id="markdown-toc-xxe-to-rce-Ô∏è">XXE to RCE ü¶∏‚Äç‚ôÄÔ∏è</a><li><a href="#n√•r-m√•-man-tenke-p√•-xml-og-xxe-hva-kan-vi-stole-p√•-Ô∏èÔ∏è" id="markdown-toc-n√•r-m√•-man-tenke-p√•-xml-og-xxe-hva-kan-vi-stole-p√•-Ô∏èÔ∏è">N√•r m√• man tenke p√• XML og XXE? Hva kan vi stole p√•? üïµÔ∏è‚Äç‚ôÄÔ∏è</a></ul><li><a href="#javel-hva-er-den-beste-m√•ten-√•-lese-xml-p√•-i-java-if√∏lge-oracle-" id="markdown-toc-javel-hva-er-den-beste-m√•ten-√•-lese-xml-p√•-i-java-if√∏lge-oracle-">Javel, hva er den beste m√•ten √• lese XML p√• i Java if√∏lge Oracle? üòë</a><ul><li><a href="#defence-in-depth-innstillinger-for-dom" id="markdown-toc-defence-in-depth-innstillinger-for-dom">Defence in depth-innstillinger for DOM</a><li><a href="#defence-in-depth-innstillinger-for-sax" id="markdown-toc-defence-in-depth-innstillinger-for-sax">Defence in depth-innstillinger for SAX</a><li><a href="#defence-in-depth-innstillinger-for-stax" id="markdown-toc-defence-in-depth-innstillinger-for-stax">Defence in depth-innstillinger for StAX</a><li><a href="#defence-in-depth-innstillinger-for-schema-og-validator" id="markdown-toc-defence-in-depth-innstillinger-for-schema-og-validator">Defence in depth-innstillinger for Schema og Validator</a><li><a href="#defence-in-depth-innstillinger-for-transformerfactorysaxtransformerfactory" id="markdown-toc-defence-in-depth-innstillinger-for-transformerfactorysaxtransformerfactory">Defence in depth-innstillinger for TransformerFactory/SAXTransformerFactory</a><li><a href="#defence-in-depth-innstillinger-for-xpathfactory" id="markdown-toc-defence-in-depth-innstillinger-for-xpathfactory">Defence in depth-innstillinger for XPathFactory</a><li><a href="#defence-in-depth-innstillinger-for-domls" id="markdown-toc-defence-in-depth-innstillinger-for-domls">Defence in depth-innstillinger for DOMLS</a><li><a href="#viktig-info" id="markdown-toc-viktig-info">Viktig info</a></ul><li><a href="#fallgruver" id="markdown-toc-fallgruver">Fallgruver</a><li><a href="#oppsummering" id="markdown-toc-oppsummering">Oppsummering</a></ul><h2 id="hvem-har-nytte-av-lese-dette-">Hvem har nytte av lese dette? üéØ</h2><p>Dette er <strong>ikke</strong> en introduksjonsartikkel, jeg regner med du har erfaring med Java og at du har snust i Javas XML-implementasjon. Du er kanskje ogs√• klar over at det finnes s√•rbarheter omkring XML som XXE og deserialiserings-angrep.<ul><li>Backend Javautviklere som leser/skriver/prosesserer XML<li>Pentestere som √∏nsker √• vite mer om Java og XML s√•rbarheter<li>Teamledere (send til teamet hvis de bruker XML)<h3 id="hvem-bruker-xml-da-kan-vi-ikke-bare-bruke-json-">Hvem bruker XML da, kan vi ikke bare bruke JSON? üòá</h3><p>XML benyttes i forferdelig mange bransjer i Norge, til forferdelig mye forskjellig. Det brukes gjerne som overf√∏ringsformat for at forskjellige systemer skal kunne snakke sammen, API-er kan eksponeres ved hjelp av XML <a href="https://en.wikipedia.org/wiki/SOAP">(SOAP)</a>, konfigurasjoner kan leses og skrives vha. XML, import/export av data i forskjellige systemer kan gjerne bruke XML, En del systemer har standarisert p√• forskjellige XML-formater i henhold til et <a href="https://en.wikipedia.org/wiki/XML_schema">XML Schema</a>.</ul><p>S√• hvis du jobber innenfor, eller oppimot bransjer som bank, finans, helse, utdanning, kartdata, regnskap, transport, offentlige institusjoner/etater s√• er det stor sannsynlighet for at du enten m√• lese eller skrive XML, eller det benyttes XML-biblioteker her og der. <strong>Som Javautvikler m√• du som regel forholde deg til XML.</strong><h3 id="xml-prosessering-i-java">XML-prosessering i Java</h3><p>Dette er alternativene man har for XML prosessering med bruk av standard Java API-er:<ul><li>JAXP - Java API for XML Processing<ul><li>DOM - Document Object Model<li>SAX - Simple API for XML<li>TrAX - Transformation API for XML + xpath<li>StAX - Streaming API for XML<li>Validation - XSD Schema and Validation<li>DOMLS - DOM Load and Save</ul><li>JAXB - Java Architecture for XML Binding</ul><p>Det finnes ogs√• en del andre biblioteker som kan h√•ndtere XML, b√•de for enkel XML, og serialisering/deserialisering av objekter til/fra XML (<a href="https://owasp.org/www-project-top-ten/2017/A8_2017-Insecure_Deserialization">med sine egne sikkerhetsproblemer</a>, stolt medlem av <a href="https://owasp.org/www-project-top-ten/">OWASP Top 10 Web Application Security Risks</a>).<p>Det er en del √• tenke p√• hvis man velger √• inkludere og bruke et eksternt bibliotek, eksempelvis utbredelse, dokumentasjon, s√•rbarheter, oppdateringsfrekvens, alder, egne rutiner for oppdatering, egne policies ++. Sjekk <a href="https://www.cvedetails.com/">cvedetails</a>, <a href="https://nvd.nist.gov/">National Vulnerability Database</a>, Stack Overflow, Google, <a href="https://www.exploit-db.com/">exploit-db</a>, deres egne nettsider for dokumentasjon for √• researche om det er et bibliotek man har lyst til √• ta i bruk.<p><strong>For denne artikkelens del s√• ser jeg ikke p√• andre biblioteker, kun standard Java-API, eksplisitt JAXP, ikke JAXB.</strong><h2 id="er-ikke-java-sikkert-som-banken-da-trenger-man-√•-tenke-p√•-det-">Er ikke Java sikkert som banken da, trenger man √• tenke p√• det? üôàüôâüôä</h2><h3 id="introduksjon">Introduksjon</h3><p>Dette eksempelet er et eksempel hvor stort sett alt er gjort <em>‚Äúgetting started way‚Äù</em>, s√• enkelt som mulig. Det er satt opp ved hjelp av de seneste versjoner som er kompatible pr. mai 2021 av:<ul><li><a href="https://www.docker.com/">Docker 20.10.6</a>,<li><a href="https://spring.io/projects/spring-boot">Spring Boot 2.4.6</a> med Web MVC<li><a href="https://openjdk.java.net/projects/jdk/11/">Java SE 11</a></ul><p>Intensjonen er √• lage en simpel applikasjon p√• en server som skal lese XML fra request body og plukke ut en verdi. Har kan man tenke seg at verdien som plukkes ut brukes i f.eks et databaseoppslag, eller for √• berike et objekt el.l. men for enkelhets skyld returnerer jeg bare verdien som en tekststreng i en enkel <a href="https://www.json.org/json-en.html">JSON-respons</a>.<h3 id="forutsetninger">Forutsetninger</h3><p>Jeg stoler kun p√• offisielle kilder s√• jeg benytter meg av <a href="https://www.oracle.com/java/technologies/jaxp-introduction.html">tutorials fra Oracle</a>, og jeg bryr meg ikke om error h√•ndtering eller validering (Det er ikke noe schema) for √• gj√∏re koden s√• enkel som mulig. Eksemplet som jeg viser her benytter DOM, men github kildekoden inneholder ogs√• kode som demonstrerer XXE vha SAX, StAX, TrAX, xpath, Schema, Validation og DOMLS. Du kan pr√∏ve ut koden selv ved √• klone dette prosjektet og starte docker-containeren (testet p√• Ubuntu 20.04):<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt <span class="nb">install </span>openjdk-11-jdk
git clone https://github.com/fjank/vulnerable-java-xml-1.git
<span class="nb">cd </span>vulnerable-java-xml-1
./gradlew build
docker build <span class="nt">--build-arg</span> <span class="nv">JAR_FILE</span><span class="o">=</span>build/libs/<span class="se">\*</span>.jar <span class="nt">-t</span> fjank/vuln-xml <span class="nb">.</span>
docker run <span class="nt">-p</span> 8080:8080 fjank/vuln-xml <span class="nb">.</span>
</code></pre></div></div><h3 id="kode">Kode</h3><ul><li>Initialiseringen er gjort ved hjelp av <a href="https://start.spring.io/">Spring Initializr</a><li><a href="https://spring.io/guides/gs/spring-boot-docker/">Spring Boot with docker tutorial</a><li><a href="https://spring.io/guides/gs/serving-web-content/">Serving Web Content with Spring MVC tutorial</a><li><a href="https://www.oracle.com/java/technologies/jaxp-introduction.html">Java API for XML Processing (JAXP) Tutorial</a> <img src="/assets/img/blog/2021-java-xml/initializer.png" alt="Spring Initializr" /> DOM koden som kj√∏res i kontrolleren uten validering, errorh√•ndtering etc. skal se slik ut ihht tutorial:</ul><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DocumentBuilderFactory er starten for DOM parsing</span>
<span class="nc">DocumentBuilderFactory</span> <span class="n">dbf</span> <span class="o">=</span> <span class="nc">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

<span class="c1">// .newDocumentBuilder() lager DocumentBuilder som er klassen som st√•r for parsing av XML.</span>
<span class="nc">DocumentBuilder</span> <span class="n">db</span> <span class="o">=</span> <span class="n">dbf</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>

<span class="c1">// .parse(...) for √• parse til et XML Document, her ut ifra en streng via InputSource og StringReader.</span>
<span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xml</span><span class="o">)));</span>

<span class="c1">// Resten er kun API kall for √• plukke ut verdien vi er p√• jakt etter, ikke s√• viktig for denne artikkel.</span>
<span class="o">...</span>
</code></pre></div></div><p>For √• teste ut at mini-applikasjonen fungerer slik den skal (hent ut tekst fra en XML-tag som postes til serveren med en HTTP request body), kan man for eksempel bruke <a href="https://www.postman.com/">Postman</a>, Eller hvis du har sjekket ut prosjektet nevnt over, s√• finner du en form p√• http://localhost:8080 hvor du kan modifisere XML slik at den blir som under.<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;root&gt;</span>
    <span class="nt">&lt;test&gt;</span>It works!<span class="nt">&lt;/test&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</code></pre></div></div><p><img src="/assets/img/blog/2021-java-xml/it-works.png" alt="It works" /><ol><li>Her er request body som er en XML (<code class="language-plaintext highlighter-rouge">Content-Type: application/xml</code>)<li>Svaret ifra applikasjonen som en <code class="language-plaintext highlighter-rouge">application/json</code><li><a href="https://curl.se/">curl</a> equivalent (hvis du er mer en <code class="language-plaintext highlighter-rouge">curl</code> fan)<li>r√• request og response (hvis du vil se alt som sendes fram og tilbake)</ol><p>Dette ser jo fint og flott ut, teksten ble hentet ut som forventet, og levert tilbake som en JSON. üòé<p>üè¥‚Äç‚ò†Ô∏è La oss modde litt p√• requesten‚Ä¶ üè¥‚Äç‚ò†Ô∏è<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt;</span>]&gt;
<span class="nt">&lt;root&gt;</span>
    <span class="nt">&lt;test&gt;</span><span class="ni">&amp;xxe;</span><span class="nt">&lt;/test&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</code></pre></div></div><p><img src="/assets/img/blog/2021-java-xml/ouch.png" alt="Ouch!" /><h2 id="nasty-stuff-hva-er-dette-">Nasty stuff, hva er dette? ü•∂</h2><p>Jeg utnyttet her en XXE for LFI mot DOM-koden. Det samme skjer ogs√• mot alle de andre API-ene i JAXP, sjekk gjerne ut koden og pr√∏v selv for √• verifisere at dette er tilfelle.<h3 id="xxe-for-lfi-"><a href="https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing">XXE</a> for <a href="https://en.wikipedia.org/wiki/File_inclusion_vulnerability">LFI</a> üëÄ</h3><p>Lo and behold, jeg fikk lest ut filen <code class="language-plaintext highlighter-rouge">/etc/passwd</code>. Heldigvis s√• er applikasjonen startet med en spesifikk bruker (<em>spring</em>, definert i Dockerfile) hvis jeg ikke hadde spesifisert en bruker, hadde applikasjonen blitt startet som <em>root</em>, og jeg hadde hatt full lesetilgang til alle filer p√• hele docker-containeren. N√• er det iallefall kun begrenset til filer som bruker <em>spring</em> har tilgang til. Det er ille nok, jeg kan f.eks. lese ut konfigurasjonen til applikasjonen med brukernavn, passord, tokens, kanskje ogs√• SSH-n√∏kler, laste ned klassefilene og dekompilere de for √• pl√∏ye gjennom kildekoden etter flere s√•rbarheter, pl√∏ye gjennom loggfiler, historikkfiler osv. osv. Jeg kan lese alt som brukeren <em>spring</em> har tilgang til. <em>Fun fact: hvis serveren kj√∏rer p√• en windows-boks, og du spesifiserer en mappe i XML exploit isteden for en fil, s√• f√•r du ut directory listingen!</em><h4 id="oob-xxe"><a href="https://www.acunetix.com/blog/articles/band-xml-external-entity-oob-xxe/">OOB-XXE</a></h4><p>Hvis man ikke f√•r resultatet tilbake direkte kan man bruke out-of-band teknikker for likevel √• lese filer. Det er mulig √• benytte OOB-XXE i <code class="language-plaintext highlighter-rouge">javax.xml.validation.Validator</code> i Java 11 for √• lese enkle filer uten linjeskift.<h4 id="error-based-xxe"><a href="https://niravgadhiya.blogspot.com/2020/03/blind-error-based-xxe.html">Error based XXE</a></h4><p>Hvis man f√•r feilmeldinger tilbake fra serveren, kan man pr√∏ve √• injecte i selve feilmeldingen.<h3 id="xxe-for-dos-">XXE for <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DoS</a> üí£</h3><p>Jeg kan pr√∏ve √• kr√¶sje serveren, bare for √• v√¶re ond med f.eks. <a href="https://en.wikipedia.org/wiki/Billion_laughs_attack">billion laughs attack</a>, men det er ikke noe g√∏y, dessuten har java 11 default beskyttelse for √• unng√• dette. üòÖ<h3 id="xxe-for-portscanning-og-nettverksscanning-">XXE for <a href="https://en.wikipedia.org/wiki/Port_scanner">portscanning</a> og nettverksscanning üîé</h3><p>Eksempelvis ved √• bruke <code class="language-plaintext highlighter-rouge">&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "http://internal-server.intra.net:22"&gt;]&gt;</code> s√• vil XML-parser pr√∏ve √• connecte til den serveren p√• port 22, typisk √•pen p√• Linux-maskiner, eller vi kan bruke port 139, typisk √•pen p√• Windows-maskiner. Finnes maskinen, s√• vil det g√• raskt (DNS-oppslaget returnerer med en gang), finnes den ikke g√•r DNS-oppslaget tregere, ergo kan vi bruke timing og gigantiske ordlister for √• mappe opp maskiner p√• samme nettverk (<strong>bak brannmuren, husk at det er serveren som hoster applikasjonen som utf√∏rer kallene</strong>). Jakting p√• tjenester og porter ved hjelp av XXE er g√∏y.<h3 id="xxe-for-ssrf-">XXE for <a href="https://owasp.org/www-community/attacks/Server_Side_Request_Forgery">SSRF</a> üê±‚Äçüë§</h3><p>Er vi heldige s√• f√•r vi svaret v√•rt tilbake i en respons, da kan vi etter √• ha kj√∏rt hostscanning og portscanning, foresp√∏rre interne nettverksressurser uten √• tenke p√• brannmurregler. <a href="https://www.aon.com/cyber-solutions/aon_cyber_labs/ssrf-and-xxe-vulnerabilities-in-pdfreactor/">Her er et eksempel ifra virkeligheten</a>.<h3 id="xxe-to-rce-Ô∏è">XXE to <a href="https://en.wikipedia.org/wiki/Arbitrary_code_execution">RCE</a> ü¶∏‚Äç‚ôÄÔ∏è</h3><p>XXE alene er ikke s√• g√∏y, det er n√•r man kan kombinere med andre s√•rbarheter at det begynner √• bli g√∏y. <a href="https://www.ambionics.io/blog/oracle-peoplesoft-xxe-to-rce">Her er et nasty eksempel fra 2018</a> p√• en XXE som ble utnyttet til √• f√• <code class="language-plaintext highlighter-rouge">nt authority/system</code> shell p√• alle servere med Oracle PeopleSoft installert.<h3 id="n√•r-m√•-man-tenke-p√•-xml-og-xxe-hva-kan-vi-stole-p√•-Ô∏èÔ∏è">N√•r m√• man tenke p√• XML og XXE? Hva kan vi stole p√•? üïµÔ∏è‚Äç‚ôÄÔ∏è</h3><p>Alle XML-er som man ikke har kontroll p√• b√∏r man ikke stole p√•.<ul><li>XML-er som kommer inn som en request ifra internet: √Öfy!<li>XML-er ifra en partner: sikker p√• at partneren har kontroll? Ikke stol p√• det.<li>XML-er fra en server i samme VLAN: Sikker p√• at maskinen ikke er kompromittert? Don‚Äôt trust it!<li>XML-er p√• disk: Sikker p√• at ingen har tuklet med de?<li>Osv osv.</ul><p>Ikke stol p√• noen, ha som utgangspunkt at XML som skal prosesseres er ondskapens verk som kun er ute etter √• lage br√•k.<h2 id="javel-hva-er-den-beste-m√•ten-√•-lese-xml-p√•-i-java-if√∏lge-oracle-">Javel, hva er den beste m√•ten √• lese XML p√• i Java if√∏lge Oracle? üòë</h2><p>√Ö kun lese og bruke <a href="https://www.oracle.com/java/technologies/jaxp-introduction.html">Java API for XML Processing (JAXP) Tutorial</a> er ikke nok for √• prosessere XML p√• en sikker m√•te. <strong>Man m√• ogs√• lese <a href="https://docs.oracle.com/en/java/javase/11/security/index.html">sikkerhetsguide for utviklere</a>,</strong> spesifikt kapittel 12 hvor vi finner en god del mer informasjon. Man m√• lese denne med lupe, for her st√•r det at <a href="https://docs.oracle.com/en/java/javase/11/security/java-api-xml-processing-jaxp-security-guide.html#GUID-88B04BE2-35EF-4F61-B4FA-57A0E9102342">FSP</a> er default p√• for √• beskytte mot DoS, men det tilgjengeliggj√∏r fremdeles eksterne entiteter, <a href="https://docs.oracle.com/en/java/javase/11/security/java-api-xml-processing-jaxp-security-guide.html#GUID-94ABC0EE-9DC8-44F0-84AD-47ADD5340477">den m√• eksplisitt settes for √• blokkere XXE</a>. <strong>JAXP er ‚Äúvulnerable by design‚Äù</strong> ü§Ø.<p>For √• beskytte seg mot 0-days, ukjente bugs eller framtidige bugs som enda ikke er laget, b√∏r man bruke <a href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)">defence-in-depth</a> tankegang, og skru p√• alle sikkerhets-features for XML-parsere, selv om de tilsynelatende ikke er n√∏dvendig. Det kan for eksempel v√¶re en spesifikk kodebane i JAXP/JAXB som gj√∏r at den ene sikkerhets-featuren ikke blir trigget. Har man kun den beskyttelsen, s√• har angripere funnet en √•pning. Derimot hvis man har skrudd p√• flere lag med beskyttelse, s√• vil forh√•pentligvis angrepet bli stoppet av neste lag.<p>Etter min mening er sikkerhetsguiden forferdelig. Komplisert, ikke komplett, ustrukturert og kommer med vage anbefalinger, s√• den b√∏r ikke v√¶re eneste kilde til sannheten.<p>Ei heller har ikke alle factories st√∏tte for de samme features og properties, s√• man m√• finne ut hva som er st√∏ttet og ikke st√∏ttet for hver enkelt type ved hjelp av API-dokumentasjon, JAXP Security Guide, inspisering av JDK-kildekode (f.eks. debugging) og andre kilder (pentestrapporter, s√•rbarhetsrapporter, bug bounty-rapporter etc.). Under f√∏lger min anbefaling for de forskjellige delene av JAXP, tror jeg har f√•tt med meg alle sammen. <em>Jeg skal f√• sjekket om buggen jeg fant (DOMLS) er rapportert eller ikke, og rapportere den.</em><p>Selvf√∏lgelig s√• b√∏r man bruke standard OO teknikker f.eks. factories, factory methods, singletons e.l. for √• f√• config p√• en plass. Dette gjelder for programmatisk konfigurasjon av JAXP factories. Det er ogs√• mulig √• bruke jaxp.properties og/eller System properties, men det er utenfor scope til denne artikkelen.<p><strong>Bruk eksemplene under som det de er, eksempler! Les <a href="#Viktig-info">viktig info under eksemplene.</a></strong><h3 id="defence-in-depth-innstillinger-for-dom">Defence in depth-innstillinger for DOM</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// For DOM, skru p√• sikkerhetsinnstillinger via SAXParserFactory</span>
<span class="nc">DocumentBuilderFactory</span> <span class="n">dbf</span> <span class="o">=</span> <span class="nc">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

<span class="c1">// skru p√• FSP</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">FEATURE_SECURE_PROCESSING</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

<span class="c1">// skru av mulighetene for at XML kan ha en DOCTYPE</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/disallow-doctype-decl"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne DTDs</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne entiteter</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne parameter-entiteter</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span>  <span class="kc">false</span><span class="o">);</span>

<span class="c1">// Sett tillatte protokoller for ekstern DTD til ingen</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_DTD</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
<span class="c1">// Sett tillatte protokoller for eksterne schema til ingen</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_SCHEMA</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>

<span class="c1">// skru av xinclude st√∏tte </span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setXIncludeAware</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/xinclude"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">// skru av entity resolution</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setExpandEntityReferences</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

<span class="c1">// N√• kan du lage en DocumentBuilder og parse p√• en trygg m√•te.</span>
<span class="nc">DocumentBuilder</span> <span class="n">db</span> <span class="o">=</span> <span class="n">dbf</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
<span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xml</span><span class="o">)));</span>
</code></pre></div></div><h3 id="defence-in-depth-innstillinger-for-sax">Defence in depth-innstillinger for SAX</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Defence in depth innstillinger for SAX</span>
<span class="c1">// For SAX, skru p√• sikkerhetsinnstillinger via SAXParserFactory</span>
<span class="nc">SAXParserFactory</span> <span class="n">spf</span> <span class="o">=</span> <span class="nc">SAXParserFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

<span class="c1">// skru p√• FSP</span>
<span class="n">spf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">FEATURE_SECURE_PROCESSING</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

<span class="c1">// skru av mulighetene for at XML kan ha en DOCTYPE</span>
<span class="n">spf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/disallow-doctype-decl"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne DTDs</span>
<span class="n">spf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne entiteter</span>
<span class="n">spf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne parameter-entiteter</span>
<span class="n">spf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span>  <span class="kc">false</span><span class="o">);</span>


<span class="c1">// skru av xinclude st√∏tte </span>
<span class="n">spf</span><span class="o">.</span><span class="na">setXIncludeAware</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">spf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/xinclude"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">//N√• kan du lage en SAXParser med en ContentHandler og parse p√• en trygg m√•te.</span>
</code></pre></div></div><h3 id="defence-in-depth-innstillinger-for-stax">Defence in depth-innstillinger for StAX</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Beware! StAX st√∏tter ikke FSP!</span>
<span class="c1">// For StAX, skru p√• sikkerhetsinnstillinger via XMLInputFactory</span>
<span class="nc">XMLInputFactory</span> <span class="n">f</span> <span class="o">=</span> <span class="nc">XMLInputFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

<span class="c1">// Skru av st√∏tte for DOCTYPE</span>
<span class="n">f</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">XMLInputFactory</span><span class="o">.</span><span class="na">SUPPORT_DTD</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">// Skru av st√∏tte for eksterne entiteter</span>
<span class="n">f</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">XMLInputFactory</span><span class="o">.</span><span class="na">IS_SUPPORTING_EXTERNAL_ENTITIES</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

<span class="c1">// Sett tillatte protokoller for ekstern DTD til ingen</span>
<span class="n">f</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_DTD</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
<span class="c1">// Sett tillatte protokoller for eksterne schema til ingen</span>
<span class="n">f</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_SCHEMA</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>

<span class="c1">// Skru p√• ignorering av eksterne DTD's.</span>
<span class="n">f</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"http://java.sun.com/xml/stream/properties/ignore-external-dtd"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="c1">//N√• kan du lage en XMLStreamReader/XMLEventReader og plukke verdier p√• en trygg m√•te.</span>
</code></pre></div></div><h3 id="defence-in-depth-innstillinger-for-schema-og-validator">Defence in depth-innstillinger for Schema og Validator</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// XXE i Schema/Validator er som regel error-basert eller OOB</span>
<span class="nc">SchemaFactory</span> <span class="n">sf</span> <span class="o">=</span> <span class="nc">SchemaFactory</span><span class="o">.</span><span class="na">newDefaultInstance</span><span class="o">();</span>

<span class="c1">// skru p√• FSP</span>
<span class="n">sf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">FEATURE_SECURE_PROCESSING</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

<span class="c1">// Sett tillatte protokoller for ekstern DTD til ingen</span>
<span class="n">sf</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_DTD</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
<span class="c1">// Sett tillatte protokoller for eksterne schema til ingen</span>
<span class="n">sf</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_SCHEMA</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>

<span class="c1">// Schema vil n√• f√• sine innstillinger fra SchemaFactory</span>
<span class="nc">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="na">newSchema</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xml</span><span class="o">)));</span>
<span class="c1">// Validator vil ogs√• f√• sine innstillinger fra SchemaFactory</span>
<span class="nc">Validator</span> <span class="n">validator</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="na">newValidator</span><span class="o">();</span>
<span class="cm">/* Det er ogs√• mulig √• hente en ValidatorHandler med newValidatorHandler(),
 * men jeg har ikke brukt den og vet heller ikke hvordan den fungerer, 
 derfor har jeg heller ingen eksempelinstillinger for denne.*/</span>
</code></pre></div></div><h3 id="defence-in-depth-innstillinger-for-transformerfactorysaxtransformerfactory">Defence in depth-innstillinger for TransformerFactory/SAXTransformerFactory</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Her er det mulig √• injecte b√•de i xml og i stylesheet</span>
<span class="nc">TransformerFactory</span> <span class="n">tf</span> <span class="o">=</span> <span class="nc">TransformerFactory</span><span class="o">.</span><span class="na">newDefaultInstance</span><span class="o">();</span>

<span class="c1">// skru p√• FSP</span>
<span class="n">tf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">FEATURE_SECURE_PROCESSING</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

<span class="c1">// Sett tillatte protokoller for ekstern DTD til ingen</span>
<span class="n">tf</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_DTD</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
<span class="c1">// Sett tillatte protokoller for eksterne stylesheets til ingen</span>
<span class="n">tf</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_STYLESHEET</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>

<span class="c1">// Her brukes StreamSource, bruker man DOMSource, SAXSource eller StAXSource, </span>
<span class="c1">// s√∏rg ogs√• for √• sette defence in depth-innstillinger for disse kildene.</span>
<span class="nc">StringWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="o">();</span>
<span class="nc">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamResult</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
<span class="nc">Transformer</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xslt</span><span class="o">)));</span>
<span class="n">t</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xml</span><span class="o">)),</span> <span class="n">result</span><span class="o">);</span>
</code></pre></div></div><h3 id="defence-in-depth-innstillinger-for-xpathfactory">Defence in depth-innstillinger for XPathFactory</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">XPathFactory</span> <span class="n">xpf</span> <span class="o">=</span> <span class="nc">XPathFactory</span><span class="o">.</span><span class="na">newDefaultInstance</span><span class="o">();</span>
<span class="c1">// Skru p√• FSP, men den skrur kun av eksterne xpath funksjoner. XXE via xml er fremdeles mulig!</span>
<span class="n">xpf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">FEATURE_SECURE_PROCESSING</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="nc">XPath</span> <span class="n">xPath</span> <span class="o">=</span> <span class="n">xpf</span><span class="o">.</span><span class="na">newXPath</span><span class="o">();</span>
<span class="nc">XPathExpression</span> <span class="n">xpe</span> <span class="o">=</span> <span class="n">xPath</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">expression</span><span class="o">);</span>
<span class="c1">// Ikke bruk xpe.evaluate(inputSource, XPathConstants.STRING), siden den bruker en utrygg DocumentBuilderFactory</span>
<span class="c1">// Lag en DocumentBuilderBuilderFactory som hindrer XXE, parse deretter til org.w3c.dom.Document og send dette til evaluate.</span>
<span class="nc">DocumentBuilderFactory</span> <span class="n">dbf</span> <span class="o">=</span> <span class="nc">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newDefaultInstance</span><span class="o">();</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">FEATURE_SECURE_PROCESSING</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/disallow-doctype-decl"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_DTD</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">ACCESS_EXTERNAL_SCHEMA</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setXIncludeAware</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/xinclude"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="n">dbf</span><span class="o">.</span><span class="na">setExpandEntityReferences</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

<span class="nc">DocumentBuilder</span> <span class="n">db</span> <span class="o">=</span> <span class="n">dbf</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
<span class="nc">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xml</span><span class="o">)));</span>
<span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">xpe</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">document</span><span class="o">,</span> <span class="nc">XPathConstants</span><span class="o">.</span><span class="na">STRING</span><span class="o">);</span>
</code></pre></div></div><h3 id="defence-in-depth-innstillinger-for-domls">Defence in depth-innstillinger for DOMLS</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DOMImplementationRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="nc">DOMImplementationRegistry</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
<span class="nc">DOMImplementationLS</span> <span class="n">impl</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DOMImplementationLS</span><span class="o">)</span> <span class="n">registry</span><span class="o">.</span><span class="na">getDOMImplementation</span><span class="o">(</span><span class="s">"LS"</span><span class="o">);</span>
<span class="nc">LSParser</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="na">createLSParser</span><span class="o">(</span><span class="nc">DOMImplementationLS</span><span class="o">.</span><span class="na">MODE_SYNCHRONOUS</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="nc">DOMConfiguration</span> <span class="n">config</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">getDomConfig</span><span class="o">();</span>

<span class="c1">// FSP er st√∏ttet, men en subtil bug hindrer oss i √• aktivere FSP.</span>
<span class="c1">//dbf.setParameter(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>

<span class="c1">// skru av mulighetene for at XML kan ha en DOCTYPE</span>
<span class="c1">// ekvivalente verdier.</span>
<span class="n">config</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"disallow-doctype"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="n">config</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/disallow-doctype-decl"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne DTDs</span>
<span class="n">config</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne entiteter</span>
<span class="n">config</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="c1">// skru av mulighetene for eksterne parameter-entiteter</span>
<span class="n">config</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span>  <span class="kc">false</span><span class="o">);</span>

<span class="c1">// Skru av XInclude:</span>
<span class="n">config</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/xinclude"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

<span class="c1">// N√• kan du lage en LSInput og parse p√• en trygg m√•te.</span>
<span class="nc">LSInput</span> <span class="n">lsInput</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="na">createLSInput</span><span class="o">();</span>
<span class="n">lsInput</span><span class="o">.</span><span class="na">setCharacterStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xml</span><span class="o">));</span>
<span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">lsInput</span><span class="o">);</span>
</code></pre></div></div><h3 id="viktig-info">Viktig info</h3><p>Uansett om applikasjonen fungerer, eller hvis applikasjonen din gj√∏r noe litt annerledes en de enkle eksemplene over, og/eller hvis applikasjonen ikke fungerer etter dette enten fordi den bruker for mye ressurser, trenger eksterne/interne entiteter eller du absolutt skal gj√∏re noe fancy, anbefaler jeg √• gj√∏re f√∏lgende:<ul><li>Hold tunga rett i munnen<li>Les API-dokumentasjonen<li>Les <a href="https://docs.oracle.com/en/java/javase/11/security/java-api-xml-processing-jaxp-security-guide.html">JAXP Security Guide</a><li>F√∏lg Oracle‚Äôs anbefalinger for JAXP og sikkerhet som du finner <a href="https://docs.oracle.com/en/java/javase/11/security/java-api-xml-processing-jaxp-security-guide.html#GUID-82A5172C-C75E-4276-93C4-C3D2774C97E1">helt nederst i sikkerhetsguiden</a> som en en kort sjekkliste.<ul><li>Skru p√• featuren FSP, juster deretter de individuelle features og egenskaper i henhold til dine spesifikke krav.<li>For prosesseringsbegrensninger, juster de slik at de er akkurat store nok til √• h√•ndtere maksimum som applikasjonen krever.<li>For eksterne tilgangsrestriksjoner, reduser eller fjern applikasjonens avhengigheter av eksterne ressurser inkludert bruken av ‚Äúresolvere‚Äù, deretter begrens disse restriksjonene.<li>Sett opp en lokal katalog og √•pne opp Catalog API for alle XML parsere for √• ytterligere redusere applikasjonens avhengighet av eksterne ressurser.</ul><li>Sjekk andre kilder for s√•rbarheter<li>Kj√∏r code review med fokus p√• sikkerhet<li>Kj√∏r statisk kodeanalyse f.eks. <a href="https://www.sonarqube.org/">SonarQube</a>, <a href="https://find-sec-bugs.github.io/">Find Security Bugs</a>, <a href="https://semgrep.dev/">semgrep</a><li>Kj√∏r eksplisitt pentesting av delen som har med XML √• gj√∏re</ul><h2 id="fallgruver">Fallgruver</h2><ul><li><strong>Java-versjon:</strong> Denne artikkelen og tilh√∏rende eksempler er basert p√• Oracle Java versjon 11.0.9 og 11.0.11, testet p√• Windows 10 og Ubuntu 20.04. Eldre eller nyere versjoner av Java kan ha annen funksjonalitet, deprekerte klasser/metoder, andre defaults, bugs, etc. Sjekk ut API-dokumentasjon og Security guide for tilh√∏rende versjon, og gj√∏r dine egne tester.<li><strong>JVM-type:</strong> P√• samme m√•te som med Java-versjon, s√• er ogs√• <a href="https://en.wikipedia.org/wiki/List_of_Java_virtual_machines">JVM-typen</a> viktig √• ta hensyn til, forskjellige implementasjoner kan ha forskjellig underliggende funksjonalitet, forskjellige defaults, andre bugs etc. Sjekk implementasjonsspesifikke guider vedr√∏rende sikkerhet.<li><strong>Ikke default parser:</strong> Det er ogs√• mulig √• bytte ut default implementasjonen for JAXP med en annen XML-parser, (Enten p√• egen h√•nd, eller en applikasjonsserver kan trylle inn sin egen parser), som igjen kan ha forskjellig underliggende funksjonalitet, forskjellige defaults osv. Sjekk implementasjonsspesifikke guider vedr√∏rende sikkerhet hvis dette er gjort.</ul><h2 id="oppsummering">Oppsummering</h2><p>Jobber man med Java, og har med XML √• gj√∏re, s√• er sikkerhet noe man m√• tenke p√• og sette seg godt inn i. Jeg anbefaler √• ikke stole p√• noen andre enn deg selv (<em>ikke p√• meg og denne artikkelen heller</em>), utforsk sikkerhetsinnstillinger, pr√∏v √• bryt deg inn i egen kode, f√• hjelp av en pentester, viktigst av alt: <strong>ikke tro! Ha h√•ndfaste bevis for deg selv basert p√• det du selv vet.</strong><p>Denne artikkelen har kun snakket om en spesifikk XML-s√•rbarhet (XXE), men det finnes ogs√• andre s√•rbarheter som man m√• vite om og ta h√∏yde for under utvikling (f.eks. deserialiserings-angrep). Gode rutiner for sikker utvikling og kunnskap om s√•rbarheter er n√∏dvendig for √• beskytte applikasjonen(e) man skriver mot angrep, b√•de m√•lrettede og tilfeldige.<p>Finner du noen feil/svakheter/forbedringspotensiale i artikkelen eller koden p√• GitHub s√• vil jeg gjerne vite det! Legg igjen kommentarer, send epost, whatnot, jo f√∏r jo heller.<p>Hvis denne artikkelen var interessant og dere vil at jeg skal skrive mer, gjerne om noe spesifikt innenfor Java/PHP/Node/Python/C# -verdenen og en eksplisitt s√•rbarhet, legg igjen en kommentar s√• skal jeg se hva jeg f√•r til. ü•∞</article><hr class="dingbat related mb6" /><aside class="about related mt4 mb4" role="complementary"><div class="author mt4"><h2 class="page-title hr-bottom"> About</h2><p>Part time vulnerability, bug and bounty hunter. Enjoy searching for and exploiting vulnerabilities on wargames and ctf‚Äôs. Will blog about my adventures in wargames, ctf‚Äôs, bounty hunts, vulnerability explorations, both ups and downs. Hopefully you can learn something by reading and subscribing to my blog.<div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/fjankk" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/fjank" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a></ul></div></div></aside><aside class="related mb4" role="complementary"><h2 class="hr-bottom">Related Posts</h2><ul class="related-posts"><li class="h4"> <a href="/blog/2021-05-24-oscp-certified/" class="flip-title"><span>Finally OSCP certified</span></a> <time class="faded fine" datetime="2021-05-24T00:00:00+02:00">24 May 2021</time><li class="h4"> <a href="/blog/2020-12-31-pst-christmas-ctf/" class="flip-title"><span>2020 - NPST utlyser en midlertidig stilling som snikende alvebetjent</span></a> <time class="faded fine" datetime="2020-12-31T00:00:00+01:00">31 Dec 2020</time><li class="h4"> <a href="/blog/2020-03-06-etjenesten-ctf/" class="flip-title"><span>Etjenesten CTF: Vi s√∏ker deg som vil bidra i cyberoperasjoner mot trusler i utlandet</span></a> <time class="faded fine" datetime="2020-03-06T00:00:00+01:00">06 Mar 2020</time></ul></aside><aside class="comments related" role="complementary"><h2 class="hr-bottom">Comments</h2><div id="disqus_thread"></div><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <script>!function(w, d) { if (d.getElementById("disqus_thread")) { if (w.DISQUS) { w.DISQUS.reset({ reload: true, config() { this.page.url = w.location.href; this.page.title = d.title; }, }); } else { w.disqus_config = function disqusConfig() { this.page.url = w.location.href; this.page.title = d.title; }; w.loadJSDeferred(d.getElementById("_hrefDisqus").href + '/embed.js'); } } }(window, document);</script></aside><footer class="content" role="contentinfo"><hr/><p><small class="copyright">¬© 2021. All rights reserved. </small><p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">9.1.4</span></small><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(8,46,57);background-image:url(/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/" tabindex="-1"> <img src="/assets/img/logo.png" class="avatar" alt="Fjanks security pages" width="120" height="120" loading="lazy" /> </a> <a class="sidebar-title" href="/"><h2 class="h1">Fjanks security pages</h2></a><p class="fine"> A blog about security, CTF, vulnerabilities, pen-testing and other interesting things that are related to security.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_drawer--opened" href="/about/" class="sidebar-nav-item " > About </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/fjankk" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/fjank" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}(); </script> <script src="/assets/js/hydejack-9.1.4.js" type="module"></script> <script src="/assets/js/LEGACY-hydejack-9.1.4.js" nomodule defer></script> <script>!function(w, d) { w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date; /**/ ga('create', 'UA-136398928-1', 'auto'); /**/ var pushStateEl = d.getElementById('_pushState'); var timeoutId; pushStateEl.addEventListener('hy-push-state-load', function() { w.clearTimeout(timeoutId); timeoutId = w.setTimeout(function() { ga('set', 'page', w.location.pathname); ga('send', 'pageview'); }, 500); }); d.addEventListener('hy--cookies-ok', function () { w.ga(function(tracker) { w.ga("set", "anonymizeIp", undefined); localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId")); }); }); w.loadJSDeferred('https://www.google-analytics.com/analytics.js'); }(window, document);</script> <!--<![endif]--> <!-- Code for integrating CloudFlare's email protection with Hydejack's single page app loading. --> <script> document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) { function e(e){ (console.error?console.error:console.log).call(console,e) } function t(e){ return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href") } function r(e,t){ var r=e.substr(t,2);return parseInt(r,16) } function n(e,n){ for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){ var l=r(e,a)^c; o+=String.fromCharCode(l) } return t(o) } var o="/cdn-cgi/l/email-protection#", c=".__cf_email__", a="data-cfemail", l=document.createElement("div"); !function(){ for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++) try{ var c=t[r],a=c.href.indexOf(o); a>-1&&(c.href="mailto:"+n(c.href,a+o.length)) }catch(t){ e(t) } }(), function(){ for(var t=document.querySelectorAll(c),r=0;r<t.length;r++) try{ var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l); o.parentNode.replaceChild(i,o) }catch(t){ e(t) } }() }); </script><div hidden><h2 class="sr-only">Templates (for web app):</h2><clap-config> <clap-text at="1">Keep going!</clap-text> <clap-text at="2">Keep going √ó2!</clap-text> <clap-text at="3">Give me more!</clap-text> <clap-text at="5">Thank you, thank you</clap-text> <clap-text at="7">Far too kind!</clap-text> <clap-text at="10">Never gonna give me up?</clap-text> <clap-text at="14">Never gonna let me down?</clap-text> <clap-text at="20">Turn around and desert me!</clap-text> <clap-text at="30">You're an addict!</clap-text> <clap-text at="40">Son of a clapper!</clap-text> <clap-text at="50">No way</clap-text> <clap-text at="60">Go back to work!</clap-text> <clap-text at="70">This is getting out of <em>hand</em></clap-text> <clap-text at="80">Unbelievable</clap-text> <clap-text at="90">PREPOSTEROUS</clap-text> <clap-text at="100">I N S A N I T Y</clap-text> <clap-text at="185"><span style="font-family:monospace">FEED ME A STRAY CAT</span></clap-text> </clap-config> <template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading‚Ä¶</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template></div></html>
